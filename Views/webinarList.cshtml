@using System.Text.RegularExpressions
@using Umbraco.Cms.Web.Common.PublishedModels;
@using Umbraco.Extensions
@using Umbraco.Cms.Core.Models.PublishedContent
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@{
    Layout = "master.cshtml";

    // Pick up children of this "Webinar List" page that are either 'veterinaryWebinar' or 'webinar'
    var allWebinars = Model!.Children()
        .Where(x => x.IsPublished()
            && (x.ContentType.Alias == "veterinaryWebinar" || x.ContentType.Alias == "webinar"))
        .Where(x => x.Value<bool?>("active") != false)
        .OrderByDescending(x => x.Value<DateTime?>("date") ?? DateTime.MinValue)
        .ThenBy(x => x.Name)
        .ToList();

    var total = allWebinars.Count;

    string DisplayDate(IPublishedContent c)
        => c.Value<DateTime?>("date")?.ToString("MM/dd/yyyy") ?? "";

    string DisplayLength(IPublishedContent c)
        => (c.Value<string>("length") ?? "").Trim();

    string Summary(IPublishedContent c)
    {
        var html = c?.Value<string>("description") ?? "";
        return html.Trim();
    }
}

@await Html.PartialAsync("filterPanel", (Items: (IEnumerable<IPublishedContent>)allWebinars, Total: total, ItemSelector: "webinar-item"))

<div id="content_0_controls_1_pnlContentWrapper" class="content-wrapper content-webinars content-has-breadcrumb">

    <nav class="breadcrumb-nav">
        <a title="Home" href="/">Home</a>
        <a title="Webinars" href="/webinars">Webinars</a>
        <span>Veterinary Webinars</span>
    </nav>

    <header class="content-header content-header-has-icon">
        <div class="content-header-icon">
            <img src="/images/icon_webinars.png?h=109&amp;la=en&amp;w=145" alt="Webinars" width="145" height="109">
        </div>
        <h1 class="content-header-h1">Veterinary Webinars</h1>
        <div class="content-header-copy">
        </div>
    </header>

    <section class="listing">
        @if (!allWebinars.Any())
        {
            <div class="listing-item">
                <h2 class="listing-item-h2">No webinars found</h2>
                <div class="listing-item-description">
                    There aren't any active webinars to show.
                </div>
            </div>
        }
        else
        {
            foreach (var w in allWebinars)
            {
                var title = w.Value<string>("title")?.Trim();

                var tagNodes = w.Value<IEnumerable<IPublishedContent>>("tags");

                var tagKeys = tagNodes != null && tagNodes.Any()
                    ? string.Join(",", tagNodes.Where(t => t != null).Select(t => t.Key.ToString()))
                    : "";

                <div class="listing-item webinar-item" data-tags="@tagKeys" data-webinar-key="@w.Key">
                    <h2 class="listing-item-h2">@((string.IsNullOrWhiteSpace(title) ? w.Name : title))</h2>

                    <div class="listing-item-description">
                        @Html.Raw(Summary(w) ?? "")
                    </div>

                    <dl class="listing-item-date">
                        <dt>Length:</dt>
                        <dd>@DisplayLength(w)</dd>
                        <dt>Date</dt>
                        <dd>@DisplayDate(w)</dd>
                    </dl>

                    <dl class="listing-item-price">
                        <dt>Price:</dt>
                        <dd>29.95</dd>
                    </dl>

                    @if (tagNodes != null && tagNodes.Any())
                    {
                        var tagsByCategory = tagNodes
                            .Where(tag => tag != null && tag.Parent != null)
                            .GroupBy(tag => tag.Parent.Key)
                            .Select(g => new
                            {
                                CategoryKey = g.Key,
                                Category = g.First().Parent,
                                Tags = g.OrderBy(t => t.SortOrder).ToList()
                            })
                            .OrderBy(g => g.Category?.Parent?.SortOrder ?? 0)
                            .ThenBy(g => g.Category?.SortOrder ?? 0)
                            .ToList();

                        <div class="tags">
                            <div class="tagHead">Tags:</div>
                            <div class="theTags">
                                @{
                                    var isFirst = true;
                                    foreach (var categoryGroup in tagsByCategory)
                                    {
                                        var category = categoryGroup.Category;
                                        var tagsInCategory = categoryGroup.Tags;

                                        if (!isFirst)
                                        {
                                            @:,
                                        }
                                        isFirst = false;

                                        var categoryTitle = category?.Value<string>("categoryTitle") ?? category?.Name ?? "";
                                        <span class="typeTag">@categoryTitle</span>
                                        @:,

                                        var tagCount = tagsInCategory.Count;
                                        for (int i = 0; i < tagCount; i++)
                                        {
                                            var tag = tagsInCategory[i];
                                            var tagName = tag.Value<string>("tagName") ?? tag.Name;

                                            <span data-tag-key="@tag.Key">@tagName</span>

                                            if (i < tagCount - 1)
                                            {
                                                @:,
                                            }
                                        }
                                    }
                                }
                            </div>
                        </div>
                    }

                    <ul class="listing-item-btns">
                        <li class="listing-item-btn">
                            <a class="btn btn-green btn-218" href="@w.Url()">Learn More</a>
                        </li>
                    </ul>
                </div>
            }
        }
    </section>
    <article class="content-article"></article>
</div>

<style>
    /* Webinar listing styles */
    .tags {
        display: flex;
        flex-direction: row;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }

    .tagHead {
        font-weight: bold;
        margin-right: 10px;
        white-space: nowrap;
    }

    .theTags {
        flex: 1;
        line-height: 1.6;
    }

    .theTags .typeTag {
        font-weight: bold;
    }

    @@media (max-width: 768px) {
        .tags {
            flex-direction: column;
        }

        .tagHead {
            margin-bottom: 5px;
        }
    }

    /* Highlighted tag in webinar listing */
    .webinar-item .theTags span.highlight {
        background-color: #ffeb3b;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: bold;
    }
</style>
