@using System.Text.RegularExpressions
@using Umbraco.Cms.Web.Common.PublishedModels;
@using Umbraco.Extensions
@using Umbraco.Cms.Core.Models.PublishedContent
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@{
    Layout = "master.cshtml";

    // Get all protocols under this list page
    var allProtocols = Model!.Children()
        .Where(x => x.IsPublished() && x.ContentType.Alias == "protocol")
        .OrderBy(x => x.Value<string>("headline") ?? x.Name)
        .ToList();

    var total = allProtocols.Count;

    string Summary(IPublishedContent c)
    {
        var html = c?.Value<string>("shortDescription") ?? "";
        return html.Trim();
    }

    string GetPrice(IPublishedContent c)
    {
        var salePrice = c?.Value<string>("salePrice") ?? "";
        var price = c?.Value<string>("price") ?? "";
        
        if (!string.IsNullOrWhiteSpace(salePrice) && salePrice != "0" && salePrice != "0.00")
            return salePrice;
        return price;
    }
}

@await Html.PartialAsync("filterPanel", (Items: (IEnumerable<IPublishedContent>)allProtocols, Total: total, ItemSelector: "protocol-item"))

<div class="content-wrapper content-protocols content-has-breadcrumb">

    <nav class="breadcrumb-nav">
        <a title="Home" href="/">Home</a>
        <span>Protocols</span>
    </nav>

    <header class="content-header content-header-has-icon">
        <div class="content-header-icon">
            <img src="/images/icon_protocols.png?h=118&amp;la=en&amp;w=100" alt="Protocols" width="100" height="118">
        </div>
        <h1 class="content-header-h1">Protocols</h1>
    </header>

    <section class="listing">
        @if (!allProtocols.Any())
        {
            <div class="listing-item">
                <h2 class="listing-item-h2">No protocols found</h2>
                <div class="listing-item-description">
                    There aren't any protocols to show.
                </div>
            </div>
        }
        else
        {
            foreach (var p in allProtocols)
            {
                var title = p.Value<string>("headline")?.Trim();
                if (string.IsNullOrWhiteSpace(title)) title = p.Name;

                var tagNodes = p.Value<IEnumerable<IPublishedContent>>("tags");
                var tagKeys = tagNodes != null && tagNodes.Any()
                    ? string.Join(",", tagNodes.Where(t => t != null).Select(t => t.Key.ToString()))
                    : "";

                var priceDisplay = GetPrice(p);

                <div class="listing-item protocol-item" data-tags="@tagKeys" data-protocol-key="@p.Key">
                    <h2 class="listing-item-h2">@title</h2>

                    <div class="listing-item-description">
                        @Html.Raw(Summary(p) ?? "")
                    </div>

                    @if (!string.IsNullOrWhiteSpace(priceDisplay))
                    {
                        <dl class="listing-item-price">
                            <dt>Price:</dt>
                            <dd>$@priceDisplay</dd>
                        </dl>
                    }

                    <ul class="listing-item-btns">
                        <li class="listing-item-btn">
                            <a class="btn btn-green btn-218" href="@p.Url()">View Protocol</a>
                        </li>
                    </ul>

                    @if (tagNodes != null && tagNodes.Any())
                    {
                        var tagsByCategory = tagNodes
                            .Where(tag => tag != null && tag.Parent != null)
                            .GroupBy(tag => tag.Parent.Key)
                            .Select(g => new
                            {
                                CategoryKey = g.Key,
                                Category = g.First().Parent,
                                Tags = g.ToList()
                            })
                            .ToList();

                        <div class="tags">
                            <div class="tagHead">Tags:</div>
                            <div class="theTags">
                                @{
                                    var isFirst = true;
                                    foreach (var categoryGroup in tagsByCategory)
                                    {
                                        var category = categoryGroup.Category;
                                        var tagsInCategory = categoryGroup.Tags;

                                        if (!isFirst)
                                        {
                                            @:,
                                        }
                                        isFirst = false;

                                        var categoryTitle = category?.Value<string>("categoryTitle") ?? category?.Name ?? "";
                                        <span class="typeTag">@categoryTitle</span>
                                        @:,

                                        var tagCount = tagsInCategory.Count;
                                        for (int i = 0; i < tagCount; i++)
                                        {
                                            var tag = tagsInCategory[i];
                                            var tagName = tag.Value<string>("tagName") ?? tag.Name;

                                            <span data-tag-key="@tag.Key">@tagName</span>

                                            if (i < tagCount - 1)
                                            {
                                                @:,
                                            }
                                        }
                                    }
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        }
    </section>
</div>

<style>
    /* Protocol listing item spacing */
    .listing-item.protocol-item {
        padding: 20px;
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
    }

    .listing-item-btns {
        margin-top: 15px;
        margin-bottom: 15px;
        list-style: none;
        padding: 0;
    }

    /* Tags section styling */
    .tags {
        display: flex;
        flex-direction: row;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }

    .tagHead {
        font-weight: bold;
        margin-right: 10px;
        white-space: nowrap;
    }

    .theTags {
        flex: 1;
        line-height: 1.6;
    }

    .theTags .typeTag {
        font-weight: bold;
    }

    @@media (max-width: 768px) {
        .listing-item.protocol-item {
            padding: 15px;
            margin-bottom: 15px;
        }

        .tags {
            flex-direction: column;
        }

        .tagHead {
            margin-bottom: 5px;
        }
    }

    @@media (max-width: 480px) {
        .listing-item.protocol-item {
            padding: 10px;
            margin-bottom: 10px;
        }
    }
</style>
