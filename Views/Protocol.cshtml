@using Umbraco.Extensions
@using Umbraco.Cms.Core.Models.PublishedContent
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

@{
	Layout = "master.cshtml";

	// ---- Data from the protocol doctype ----
	var pageTitle = Model?.Value<string>("pageTitle")?.Trim();
	var headline = Model?.Value<string>("headline")?.Trim() ?? "";
	var title = !string.IsNullOrWhiteSpace(headline) ? headline : (pageTitle ?? Model.Name);

	var shortDescriptionHtml = Model?.Value<string>("shortDescription") ?? "";
	var price = Model?.Value<string>("price") ?? "";
	var salePrice = Model?.Value<string>("salePrice") ?? "";
	var showDiagrams = Model?.Value<bool>("showDiagrams") ?? false;

	// Protocol file (MediaPicker3)
	var protocolFile = Model?.Value<IPublishedContent>("protocolFile");
	var protocolFileUrl = protocolFile?.Url() ?? "";

	// Diagram Images (MediaPicker3 - multiple)
	var diagramImage = Model?.Value<IPublishedContent>("diagramImages")
		?? null;

	// Ancestor breadcrumbs
	var crumbs = Model?.AncestorsOrSelf()?.OrderBy(x => x.Level).ToList() ?? new List<IPublishedContent>();

	// Related protocols (siblings)
	var related = Model?.Siblings()?
		.Where(x => x.IsPublished() && x.ContentType.Alias == "protocol")
		.Take(3)
		.ToList() ?? new List<IPublishedContent>();

	string Summary(IPublishedContent c)
	{
		var html = c?.Value<string>("shortDescription") ?? "";
		var text = html.StripHtml().Trim();
		return System.Net.WebUtility.HtmlDecode(text);
	}

	// Price display logic
	var displayPrice = "";
	var hasSale = !string.IsNullOrWhiteSpace(salePrice) && salePrice != "0" && salePrice != "0.00";
	if (hasSale)
	{
		displayPrice = salePrice;
	}
	else if (!string.IsNullOrWhiteSpace(price))
	{
		displayPrice = price;
	}
}

<style>
	.protocol-detail .theProductPrice {
		display: block;
		margin: 15px 0;
	}

	.protocol-detail .product-info-btns {
		display: block;
		margin-top: 15px;
	}

	.protocol-diagrams {
		margin-top: 30px;
		padding-top: 20px;
		border-top: 1px solid #ddd;
	}

	.protocol-diagrams-h2 {
		margin-bottom: 20px;
	}

	.protocol-diagrams-wrapper {
		display: flex;
		flex-wrap: wrap;
		gap: 20px;
	}

	.protocol-diagram-item {
		flex: 1 1 300px;
		max-width: 100%;
	}

		.protocol-diagram-item img {
			width: 100%;
			height: auto;
			border: 1px solid #eee;
			border-radius: 4px;
		}

	@@media (max-width: 768px) {
		.protocol-diagrams-wrapper {
			flex-direction: column;
		}

		.protocol-diagram-item {
			flex: 1 1 100%;
		}
	}
</style>

<div class="content-wrapper content-protocols content-has-breadcrumb">

	<nav class="breadcrumb-nav">
		@if (crumbs?.Any() == true)
		{
			foreach (var c in crumbs)
			{
				if (c.Id == Model.Id)
				{
					<span>@c.Name</span>
				}
				else
				{
					<a title="@c.Name" href="@c.Url()">@c.Name</a>
				}
			}
		}
	</nav>

	<header class="content-header content-header-has-icon">
		<div class="content-header-icon">
			<img src="/images/icon_protocols.png?h=118&amp;la=en&amp;w=100" alt="Protocols" width="100" height="118">
		</div>
		<h1 class="content-header-h1">@title</h1>
	</header>

	<article class="content-article protocol-detail">
		@if (!string.IsNullOrWhiteSpace(shortDescriptionHtml))
		{
			@Html.Raw(shortDescriptionHtml)
		}

		@if (!string.IsNullOrWhiteSpace(displayPrice))
		{
			<div class="theProductPrice">
				<span class="heading">Price: </span>$@displayPrice
			</div>
		}

		<div class="product-info-btns">
			@if (!string.IsNullOrWhiteSpace(protocolFileUrl))
			{
				<a title="Download Protocol" class="btn btn-green" href="@protocolFileUrl" target="_blank">Download Protocol</a>
			}
			else
			{
				<a title="Purchase Protocol" class="btn btn-green buy-product-now" href="#auth">Purchase Protocol</a>
			}
		</div>
	</article>

	@* ---- Diagram Images ---- *@
	@if (showDiagrams && diagramImage != null)
	{
		<section>
			<div>
				@{
					var imgUrl = diagramImage.Url();
					var altText = diagramImage.Value<string>
					("altText") ?? diagramImage.Name;
					<img src="@imgUrl?width=300&height=300" alt="@altText" />
				}
			</div>
		</section>
	}

	@* ---- Related Protocols ---- *@
	@if (related.Any())
	{
		<section class="related-products-listing" id="related-products">
			<h2 class="related-products-h2">Related Protocols</h2>
			<div class="related-products-wrapper">
				@foreach (var p in related)
				{
					var pTitle = p.Value<string>("headline");
					if (string.IsNullOrWhiteSpace(pTitle)) pTitle = p.Name;
					<div class="related-products-item">
						<h3 class="related-products-h3">@pTitle</h3>
						<div class="related-products-description">@Summary(p)</div>
						<a title="View Protocol" class="related-products-link" href="@p.Url()">View Protocol</a>
					</div>
				}
			</div>
		</section>
	}
</div>
