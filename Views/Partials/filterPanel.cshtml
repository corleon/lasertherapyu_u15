@using Umbraco.Extensions
@using Umbraco.Cms.Core.Models.PublishedContent
@using Umbraco.Cms.Web.Common
@inject IUmbracoHelperAccessor UmbracoHelperAccessor
@model (IEnumerable<IPublishedContent> Items, int Total, string ItemSelector)
@{
    var items = Model.Items?.ToList() ?? new List<IPublishedContent>();
    var total = Model.Total;
    var itemSelector = Model.ItemSelector; // e.g., "webinar-item" or "protocol-item"

    // Get Umbraco helper
    UmbracoHelperAccessor.TryGetUmbracoHelper(out var umbracoHelper);

    // Find the Filters root node
    var filtersRoot = umbracoHelper?.ContentAtRoot()
        .DescendantsOrSelfOfType("filterRoot")
        .FirstOrDefault();

    // Collect all tag Keys used in current items
    var usedTagKeys = new HashSet<Guid>();
    foreach (var item in items)
    {
        var tags = item.Value<IEnumerable<IPublishedContent>>("tags");
        if (tags != null)
        {
            foreach (var tag in tags.Where(t => t != null))
            {
                usedTagKeys.Add(tag.Key);
            }
        }
    }

    // Build filter structure
    var filterSections = new List<dynamic>();
    if (filtersRoot != null)
    {
        var sections = filtersRoot.Children()
            .Where(s => s.ContentType.Alias == "filterSection" && s.IsPublished())
            .OrderBy(s => s.SortOrder)
            .ToList();

        foreach (var section in sections)
        {
            var categories = new List<dynamic>();

            var sectionCategories = section.Children()
                .Where(c => c.ContentType.Alias == "filterCategory" && c.IsPublished())
                .OrderBy(c => c.SortOrder)
                .ToList();

            foreach (var category in sectionCategories)
            {
                var categoryTags = category.Children()
                    .Where(t => t.ContentType.Alias == "filterTag" && t.IsPublished())
                    .OrderBy(t => t.SortOrder)
                    .Select(t => new
                    {
                        Key = t.Key,
                        Name = t.Value<string>("tagName") ?? t.Name,
                        Alias = t.GetProperty("tagKey")?.GetValue() as string ?? t.Name.ToLower().Replace(" ", "-"),
                        IsUsed = usedTagKeys.Contains(t.Key)
                    })
                    .ToList();

                if (categoryTags.Any())
                {
                    var totalTagCount = categoryTags.Count;
                    var flexColumns = (int)Math.Ceiling(totalTagCount / 25.0);
                    var columnSpan = Math.Max(1, Math.Min(flexColumns, 6));

                    categories.Add(new
                    {
                        Key = category.Key,
                        Title = category.Value<string>("categoryTitle") ?? category.Name,
                        Tags = categoryTags,
                        HasUsedTags = categoryTags.Any(t => t.IsUsed),
                        ColumnSpan = columnSpan,
                        TagCount = totalTagCount
                    });
                }
            }

            if (categories.Any())
            {
                filterSections.Add(new
                {
                    Key = section.Key,
                    Title = section.Value<string>("sectionTitle") ?? section.Name,
                    Categories = categories
                });
            }
        }
    }
}

<div class="filterWrap" id="filter-wrap">
    <span class="loader-spinny" style="display: none;"></span>
    <div class="feature-banner-shadow"></div>

    <div class="searchTopBanner">
        <div class="inner">
            <h2>Advanced Search</h2>
            <span class="totalResults">@total</span>
            <h3>Results:</h3>
            <div class="filterReset">
                <a href="#" title="Reset Filter" id="resetFilter">Reset Filter</a>
            </div>
        </div>
    </div>

    <div class="instructions">
        <p>Click on the <img src="/images/smallPlus.jpg" alt="">below to filter your results. Once done, scroll down to view.</p>
    </div>

    <div class="accordionWrap">
        @foreach (var filterSection in filterSections)
        {
            <div class="accordionPanel" data-id="@filterSection.Key">
                <div class="accordionHeader">
                    <div class="accordionToggle">
                        <img src="/images/accordionToggle_Plus.jpg" alt="Accordion Toggle">
                    </div>
                    <div class="accordionTitle">
                        @filterSection.Title
                    </div>
                </div>
                <div class="accordionContent" style="display: none;">
                    <div class="filterCategoriesGrid">
                        @foreach (var category in filterSection.Categories)
                        {
                            <div class="filterType"
                                 data-id="@category.Key"
                                 style="grid-column: span @category.ColumnSpan;"
                                 data-column-span="@category.ColumnSpan"
                                 data-tag-count="@category.TagCount">
                                <h3>@category.Title</h3>
                                <div class="filter-tags-container">
                                    @foreach (var tag in category.Tags)
                                    {
                                        <div class="filter-tag-item">
                                            @if (tag.IsUsed)
                                            {
                                                <span data-id="@tag.Key">
                                                    <input id="filter_@tag.Key.ToString("N")"
                                                           type="checkbox"
                                                           name="filter"
                                                           value="@tag.Key"
                                                           data-tag-key="@tag.Key"
                                                           class="filter-checkbox">
                                                    <label for="filter_@tag.Key.ToString("N")">@tag.Name</label>
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="aspNetDisabled disabled" data-id="@tag.Key">
                                                    <input id="filter_@tag.Key.ToString("N")"
                                                           type="checkbox"
                                                           name="filter"
                                                           disabled="disabled">
                                                    <label for="filter_@tag.Key.ToString("N")">@tag.Name</label>
                                                </span>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>
<div class="filterToggle">
    <img src="/images/filterToggleBtn.png" alt="Filter Toggle">
</div>

<script>
    (function() {
        'use strict';

        let selectedFilters = new Set();
        let allItems = [];
        let filteredItems = [];

        const filterCheckboxes = document.querySelectorAll('.filter-checkbox');
        const listItems = document.querySelectorAll('.@itemSelector');
        const totalResultsElement = document.querySelector('.totalResults');
        const resetButton = document.getElementById('resetFilter');

        listItems.forEach(item => {
            const tags = item.dataset.tags ? item.dataset.tags.split(',').filter(t => t.trim()) : [];
            allItems.push({
                element: item,
                tags: tags,
                tagSet: new Set(tags)
            });
        });

        filteredItems = [...allItems];

        function applyFilters() {
            if (selectedFilters.size === 0) {
                filteredItems = [...allItems];
                allItems.forEach(i => i.element.style.display = 'block');
            } else {
                filteredItems = allItems.filter(item => {
                    for (let filterKey of selectedFilters) {
                        if (!item.tagSet.has(filterKey)) {
                            return false;
                        }
                    }
                    return true;
                });

                allItems.forEach(item => {
                    item.element.style.display = filteredItems.includes(item) ? 'block' : 'none';
                });
            }

            updateResultCount();
        }

        function updateResultCount() {
            if (totalResultsElement) {
                totalResultsElement.textContent = filteredItems.length;
            }
        }

        function highlightSelectedTags() {
            document.querySelectorAll('.theTags span[data-tag-key].highlight').forEach(el => {
                el.classList.remove('highlight');
            });

            if (selectedFilters.size === 0) return;

            selectedFilters.forEach(filterKey => {
                document.querySelectorAll(`.theTags span[data-tag-key="${filterKey}"]`).forEach(span => {
                    span.classList.add('highlight');
                });
            });
        }

        filterCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const tagKey = this.value;

                if (this.checked) {
                    selectedFilters.add(tagKey);
                } else {
                    selectedFilters.delete(tagKey);
                }

                applyFilters();
                highlightSelectedTags();
            });
        });

        if (resetButton) {
            resetButton.addEventListener('click', function(e) {
                e.preventDefault();
                filterCheckboxes.forEach(cb => cb.checked = false);
                selectedFilters.clear();
                applyFilters();
                highlightSelectedTags();

                document.querySelectorAll('.accordionContent').forEach(content => {
                    content.style.display = 'none';
                });
                document.querySelectorAll('.accordionToggle img').forEach(toggle => {
                    toggle.src = '/images/accordionToggle_Plus.jpg';
                });
            });
        }

        updateResultCount();
    })();
</script>

<style>
    /* Filter grid styling */
    .filterCategoriesGrid {
        display: grid;
        grid-template-columns: repeat(6, minmax(180px, 1fr));
        grid-auto-flow: row dense;
        gap: 20px;
        padding: 20px;
        align-items: start;
    }

    @@media (max-width: 1200px) {
        .filterCategoriesGrid {
            grid-template-columns: repeat(3, 1fr);
        }

        .filterType[data-column-span="3"],
        .filterType[data-column-span="4"],
        .filterType[data-column-span="5"],
        .filterType[data-column-span="6"] {
            grid-column: span 3 !important;
        }
    }

    @@media (max-width: 768px) {
        .filterCategoriesGrid {
            grid-template-columns: repeat(2, 1fr);
        }

        .filterType {
            grid-column: span 2 !important;
        }

        .filter-tags-container {
            max-height: none !important;
        }
    }

    @@media (max-width: 480px) {
        .filterCategoriesGrid {
            grid-template-columns: 1fr;
        }

        .filterType {
            grid-column: span 1 !important;
        }
    }

    .filterType {
        display: flex;
        flex-direction: column;
        min-width: 0;
        break-inside: avoid;
    }

        .filterType input[type="checkbox"] {
            width: 10px;
            height: 10px;
            -webkit-appearance: checkbox;
        }

    .filter-tags-container {
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        max-height: 650px;
        gap: 6px;
        align-content: flex-start;
    }

    .filter-tag-item {
        display: block;
        width: 180px;
        padding-right: 10px;
        font-size: 13px;
        line-height: 1.4;
        box-sizing: border-box;
    }

        .filter-tag-item input[type="checkbox"] {
            margin-right: 6px;
            vertical-align: middle;
            width: 13px;
            height: 13px;
            opacity: 1 !important;
            position: relative !important;
            display: inline-block !important;
        }

        .filter-tag-item label {
            cursor: pointer;
            vertical-align: middle;
            display: inline;
            word-wrap: break-word;
        }

        .filter-tag-item .aspNetDisabled.disabled {
            opacity: 0.5;
        }

            .filter-tag-item .aspNetDisabled.disabled label {
                cursor: not-allowed;
            }

            .filter-tag-item .aspNetDisabled.disabled input[type="checkbox"] {
                cursor: not-allowed;
                opacity: 0.5 !important;
            }

    .theTags span.highlight {
        background-color: #ffeb3b;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: bold;
    }
</style>
